# BlueMonitor — FastAPI Setup Guide

Add uptime monitoring, heartbeat push, and a status badge to your FastAPI app.

Documentation: https://www.bluemonitor.org/docs/fastapi

## 1. Health Endpoint (optional)

```python
@app.get("/api/health")
async def health():
    return {"status": "ok"}
```

BlueMonitor pings this every 5 minutes. If it responds with 200 under 3s → operational. Over 3s → slow. Error/timeout → down.

## 2. Heartbeat Push (recommended)

Push detailed dependency health data to BlueMonitor on a schedule using APScheduler.

```bash
pip install apscheduler httpx
```

**Requirements:**
- A BlueMonitor API key (create at https://www.bluemonitor.org/dashboard)
- Service in your watchlist

```python
import os
import time
import httpx
from datetime import datetime
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from contextlib import asynccontextmanager

BLUEMONITOR_API_KEY = os.getenv("BLUEMONITOR_API_KEY")
APP_DOMAIN = os.getenv("APP_DOMAIN")

async def send_heartbeat():
    checks = {}

    # Database check
    db_start = time.monotonic()
    try:
        await database.execute("SELECT 1")
        checks["database"] = {
            "status": "ok",
            "latency": round((time.monotonic() - db_start) * 1000),
        }
    except Exception as e:
        checks["database"] = {
            "status": "error",
            "latency": round((time.monotonic() - db_start) * 1000),
            "message": str(e),
        }

    # Add more checks: redis, external APIs, etc.

    has_error = any(c["status"] == "error" for c in checks.values())

    async with httpx.AsyncClient() as client:
        await client.post(
            "https://www.bluemonitor.org/api/v1/heartbeat",
            params={"domain": APP_DOMAIN},
            headers={"Authorization": f"Bearer {BLUEMONITOR_API_KEY}"},
            json={
                "status": "error" if has_error else "ok",
                "timestamp": datetime.utcnow().isoformat(),
                "checks": checks,
            },
        )

@asynccontextmanager
async def lifespan(app):
    scheduler = AsyncIOScheduler()
    scheduler.add_job(send_heartbeat, "interval", minutes=5)
    scheduler.start()
    await send_heartbeat()  # Send on startup
    yield
    scheduler.shutdown()

app = FastAPI(lifespan=lifespan)
```

Add to `.env`:

```
BLUEMONITOR_API_KEY=bm_your_api_key
APP_DOMAIN=yourapp.com
```

## 3. Status Badge

Replace `your-domain-com` with your domain (dots become dashes).

```markdown
[![Status](https://www.bluemonitor.org/api/badge/your-domain-com)](https://www.bluemonitor.org/status/your-domain-com)
```

## Heartbeat Request Schema

POST `https://www.bluemonitor.org/api/v1/heartbeat?domain={your-domain}`

Headers: `Authorization: Bearer bm_...`, `Content-Type: application/json`

```json
{
  "status": "ok",
  "timestamp": "2026-02-12T12:00:00.000Z",
  "checks": {
    "database": { "status": "ok", "latency": 5 },
    "redis": { "status": "ok", "latency": 2 }
  }
}
```

- `status`: "ok" or "error"
- `checks`: object with dependency names as keys, each with `status`, `latency` (ms), optional `message`
- If BlueMonitor stops receiving heartbeats for 10 minutes, the service is marked as down
