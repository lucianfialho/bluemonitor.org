# BlueMonitor — FastAPI Setup Guide

Add uptime monitoring, heartbeat push, and a status badge to your FastAPI app.

Documentation: https://www.bluemonitor.org/docs/fastapi

## Important: Auto-detect the domain

Automatically detect the project's production domain from the codebase (check `.env`, `pyproject.toml`, or similar config files for `APP_URL`, `BASE_URL`, or domain references). Use the detected domain directly in the heartbeat URL — do NOT use placeholders like `yourapp.com`.

## 1. Health Endpoint (optional)

```python
@app.get("/api/health")
async def health():
    return {"status": "ok"}
```

BlueMonitor pings this every 5 minutes. If it responds with 200 under 3s → operational. Over 3s → slow. Error/timeout → down.

## 2. Heartbeat Push (recommended)

Push detailed dependency health data to BlueMonitor on a schedule using APScheduler.

```bash
pip install apscheduler httpx
```

**Requirements:**
- A BlueMonitor API key (create at https://www.bluemonitor.org/dashboard)
- The first heartbeat auto-registers the service and adds it to your watchlist

```python
import os
import time
import httpx
from datetime import datetime
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from contextlib import asynccontextmanager

BLUEMONITOR_API_KEY = os.getenv("BLUEMONITOR_API_KEY")

async def send_heartbeat():
    checks = {}

    # Database check
    db_start = time.monotonic()
    try:
        await database.execute("SELECT 1")
        checks["database"] = {
            "status": "ok",
            "latency": round((time.monotonic() - db_start) * 1000),
        }
    except Exception as e:
        checks["database"] = {
            "status": "error",
            "latency": round((time.monotonic() - db_start) * 1000),
            "message": str(e),
        }

    # Add more checks: redis, external APIs, etc.

    has_error = any(c["status"] == "error" for c in checks.values())

    async with httpx.AsyncClient() as client:
        await client.post(
            "https://www.bluemonitor.org/api/v1/heartbeat",
            headers={"Authorization": f"Bearer {BLUEMONITOR_API_KEY}"},
            json={
                "domain": "yourapp.com",
                "status": "error" if has_error else "ok",
                "timestamp": datetime.utcnow().isoformat(),
                "checks": checks,
            },
        )

@asynccontextmanager
async def lifespan(app):
    scheduler = AsyncIOScheduler()
    scheduler.add_job(send_heartbeat, "interval", minutes=5)
    scheduler.start()
    await send_heartbeat()  # Send on startup
    yield
    scheduler.shutdown()

app = FastAPI(lifespan=lifespan)
```

Add to `.env`:

```
BLUEMONITOR_API_KEY=bm_your_api_key
```

## 3. Status Badge

Replace `your-domain-com` with your domain (dots become dashes). Place the badge in your footer for maximum visibility.

```markdown
[![Status](https://www.bluemonitor.org/api/badge/your-domain-com)](https://www.bluemonitor.org/status/your-domain-com)
```

## Heartbeat Request Schema

POST `https://www.bluemonitor.org/api/v1/heartbeat`

Headers: `Authorization: Bearer bm_...`, `Content-Type: application/json`

```json
{
  "domain": "yourapp.com",
  "status": "ok",
  "timestamp": "2026-02-12T12:00:00.000Z",
  "checks": {
    "database": { "status": "ok", "latency": 5 },
    "redis": { "status": "ok", "latency": 2 }
  }
}
```

- `domain`: your service's production domain (auto-detect from project config)
- `status`: "ok" or "error"
- `checks`: object with dependency names as keys, each with `status`, `latency` (ms), optional `message`
- If BlueMonitor stops receiving heartbeats for 10 minutes, the service is marked as down

## 4. Bot Tracking (Pro)

Track which bots crawl your FastAPI app. Requires a Pro plan and API key.

Add bot detection middleware:

```python
import re
import os
import httpx
from starlette.middleware.base import BaseHTTPMiddleware

BOT_PATTERNS = [
    (re.compile(r"Googlebot", re.I), "googlebot", "search_engine"),
    (re.compile(r"bingbot", re.I), "bingbot", "search_engine"),
    (re.compile(r"GPTBot", re.I), "gptbot", "ai_crawler"),
    (re.compile(r"ChatGPT-User", re.I), "chatgpt-user", "ai_crawler"),
    (re.compile(r"ClaudeBot", re.I), "claudebot", "ai_crawler"),
    (re.compile(r"anthropic-ai", re.I), "anthropic-ai", "ai_crawler"),
    (re.compile(r"PerplexityBot", re.I), "perplexitybot", "ai_crawler"),
    (re.compile(r"Bytespider", re.I), "bytespider", "ai_crawler"),
    (re.compile(r"CCBot", re.I), "ccbot", "ai_crawler"),
    (re.compile(r"Meta-ExternalAgent", re.I), "meta-externalagent", "ai_crawler"),
    (re.compile(r"Google-Extended", re.I), "google-extended", "ai_crawler"),
    (re.compile(r"Twitterbot", re.I), "twitterbot", "social"),
    (re.compile(r"facebookexternalhit", re.I), "facebookbot", "social"),
    (re.compile(r"LinkedInBot", re.I), "linkedinbot", "social"),
    (re.compile(r"AhrefsBot", re.I), "ahrefsbot", "seo"),
    (re.compile(r"SemrushBot", re.I), "semrushbot", "seo"),
    (re.compile(r"UptimeRobot", re.I), "uptimerobot", "monitoring"),
]

def identify_bot(ua: str):
    for pattern, name, category in BOT_PATTERNS:
        if pattern.search(ua):
            return {"name": name, "category": category}
    return None

class BotTrackingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        ua = request.headers.get("user-agent", "")
        bot = identify_bot(ua)
        if bot:
            try:
                async with httpx.AsyncClient() as client:
                    await client.post(
                        "https://www.bluemonitor.org/api/v1/bot-visits",
                        headers={"Authorization": f"Bearer {os.getenv('BLUEMONITOR_API_KEY')}"},
                        json={
                            "domain": "yourapp.com",
                            "visits": [{"bot_name": bot["name"], "bot_category": bot["category"], "path": str(request.url.path), "user_agent": ua}],
                        },
                        timeout=5,
                    )
            except Exception:
                pass
        return await call_next(request)

app.add_middleware(BotTrackingMiddleware)
```

- Requires Pro plan + `BLUEMONITOR_API_KEY` env variable
- View results in the BlueMonitor dashboard under "Bot Tracking"
