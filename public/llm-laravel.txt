# BlueMonitor — Laravel Setup Guide
# Version: 2.0
# Last-Updated: 2026-02-14
# Changelog: Added bot tracking middleware (Pro), API endpoint checks in heartbeat, badge footer placement

Add uptime monitoring, heartbeat push, and a status badge to your Laravel app.

Documentation: https://www.bluemonitor.org/docs/laravel

## Update Notice (v2.0)

If this project already has BlueMonitor set up, check for these issues before adding anything new:

1. **Bot patterns**: Compare the project's bot patterns against the list in Section 4 below. If missing newer bots (ChatGPT-User, anthropic-ai, Bytespider, CCBot, Meta-ExternalAgent, Google-Extended, LinkedInBot, SemrushBot, UptimeRobot), add them.
2. **Queue for bot tracking**: If bot visits are sent inline (blocking the request), consider dispatching to a queue job for better performance.

If none of these apply or BlueMonitor is not yet set up, proceed with the fresh install below.

## Important: Auto-detect the domain

Automatically detect the project's production domain from the codebase (check `.env` for `APP_URL`, or `config/app.php`). Use the detected domain directly in the heartbeat URL — do NOT use placeholders like `yourapp.com`.

## 1. Health Endpoint (optional)

Add to `routes/api.php`:

```php
Route::get('/health', function () {
    return response()->json(['status' => 'ok']);
});
```

This exposes `GET /api/health` (Laravel prefixes API routes with `/api`).

BlueMonitor pings this every 5 minutes. If it responds with 200 under 3s → operational. Over 3s → slow. Error/timeout → down.

## 2. Heartbeat Push (recommended)

Push detailed health data to BlueMonitor using Laravel Scheduler. This checks your database, cache, external APIs, and your own API endpoints.

**Requirements:**
- A BlueMonitor API key (create at https://www.bluemonitor.org/dashboard)
- The first heartbeat auto-registers the service and adds it to your watchlist

**Important: Auto-discover checks.** Scan the project for dependencies and routes to build a comprehensive heartbeat. Look for:
- **Database**: Eloquent/DB facade → add a `SELECT 1` check
- **Redis/Cache**: Redis facade, Cache facade → add a `PING` check
- **External APIs**: Stripe, AWS, mail drivers → add lightweight checks
- **API endpoints**: scan `routes/api.php` for GET routes → add HTTP checks for key endpoints

Create `app/Console/Commands/SendHeartbeat.php`:

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Redis;

class SendHeartbeat extends Command
{
    protected $signature = 'heartbeat:send';
    protected $description = 'Send health heartbeat to BlueMonitor';

    public function handle()
    {
        $checks = [];
        $baseUrl = config('app.url');

        // Infrastructure checks
        $this->checkTiming('database', $checks, fn () => DB::select('SELECT 1'));
        $this->checkTiming('redis', $checks, fn () => Redis::ping());
        // $this->checkTiming('stripe', $checks, fn () => \Stripe\Balance::retrieve());

        // API endpoint checks — add your key routes here
        // $this->checkEndpoint('api:/api/users', "{$baseUrl}/api/users", $checks);
        // $this->checkEndpoint('api:/api/products', "{$baseUrl}/api/products", $checks);

        $hasError = collect($checks)->contains('status', 'error');

        Http::withToken(config('services.bluemonitor.key'))
            ->post('https://www.bluemonitor.org/api/v1/heartbeat', [
                'domain' => 'yourapp.com',
                'status' => $hasError ? 'error' : 'ok',
                'timestamp' => now()->toISOString(),
                'checks' => $checks,
            ]);

        $this->info('Heartbeat sent.');
    }

    private function checkTiming(string $name, array &$checks, callable $fn): void
    {
        $start = microtime(true);
        try {
            $fn();
            $checks[$name] = [
                'status' => 'ok',
                'latency' => round((microtime(true) - $start) * 1000),
            ];
        } catch (\Exception $e) {
            $checks[$name] = [
                'status' => 'error',
                'latency' => round((microtime(true) - $start) * 1000),
                'message' => $e->getMessage(),
            ];
        }
    }

    private function checkEndpoint(string $name, string $url, array &$checks): void
    {
        $start = microtime(true);
        try {
            $res = Http::timeout(5)->get($url);
            $checks[$name] = [
                'status' => $res->successful() ? 'ok' : 'error',
                'latency' => round((microtime(true) - $start) * 1000),
                'message' => $res->successful() ? null : "HTTP {$res->status()}",
            ];
        } catch (\Exception $e) {
            $checks[$name] = [
                'status' => 'error',
                'latency' => round((microtime(true) - $start) * 1000),
                'message' => $e->getMessage(),
            ];
        }
    }
}
```

Add to `routes/console.php` (Laravel 11+):

```php
Schedule::command('heartbeat:send')->everyFiveMinutes();
```

Add to `config/services.php`:

```php
'bluemonitor' => [
    'key' => env('BLUEMONITOR_API_KEY'),
],
```

Add to `.env`:

```
BLUEMONITOR_API_KEY=bm_your_api_key
```

## 3. Status Badge

Replace `your-domain-com` with your domain (dots become dashes). Place the badge in your footer for maximum visibility.

### Blade

```html
<a href="https://www.bluemonitor.org/status/your-domain-com" target="_blank" rel="noopener">
  <img src="https://www.bluemonitor.org/api/badge/your-domain-com" alt="Status on BlueMonitor" height="36" />
</a>
```

### Markdown (README.md)

```markdown
[![Status](https://www.bluemonitor.org/api/badge/your-domain-com)](https://www.bluemonitor.org/status/your-domain-com)
```

## Heartbeat Request Schema

POST `https://www.bluemonitor.org/api/v1/heartbeat`

Headers: `Authorization: Bearer bm_...`, `Content-Type: application/json`

```json
{
  "domain": "yourapp.com",
  "status": "ok",
  "timestamp": "2026-02-12T12:00:00.000Z",
  "checks": {
    "database": { "status": "ok", "latency": 5 },
    "redis": { "status": "ok", "latency": 2 }
  }
}
```

- `domain`: your service's production domain (auto-detect from project config)
- `status`: "ok" or "error"
- `checks`: object with dependency names as keys, each with `status`, `latency` (ms), optional `message`
- If BlueMonitor stops receiving heartbeats for 10 minutes, the service is marked as down

## 4. Bot Tracking (Pro)

Track which bots crawl your Laravel app. Requires a Pro plan and API key.

Create `app/Http/Middleware/TrackBots.php`:

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;

class TrackBots
{
    private const BOT_PATTERNS = [
        ['/Googlebot/i', 'googlebot', 'search_engine'],
        ['/bingbot/i', 'bingbot', 'search_engine'],
        ['/GPTBot/i', 'gptbot', 'ai_crawler'],
        ['/ChatGPT-User/i', 'chatgpt-user', 'ai_crawler'],
        ['/ClaudeBot/i', 'claudebot', 'ai_crawler'],
        ['/anthropic-ai/i', 'anthropic-ai', 'ai_crawler'],
        ['/PerplexityBot/i', 'perplexitybot', 'ai_crawler'],
        ['/Bytespider/i', 'bytespider', 'ai_crawler'],
        ['/CCBot/i', 'ccbot', 'ai_crawler'],
        ['/Meta-ExternalAgent/i', 'meta-externalagent', 'ai_crawler'],
        ['/Google-Extended/i', 'google-extended', 'ai_crawler'],
        ['/Twitterbot/i', 'twitterbot', 'social'],
        ['/facebookexternalhit/i', 'facebookbot', 'social'],
        ['/LinkedInBot/i', 'linkedinbot', 'social'],
        ['/AhrefsBot/i', 'ahrefsbot', 'seo'],
        ['/SemrushBot/i', 'semrushbot', 'seo'],
        ['/UptimeRobot/i', 'uptimerobot', 'monitoring'],
    ];

    public function handle(Request $request, Closure $next)
    {
        $ua = $request->userAgent() ?? '';
        $bot = $this->identifyBot($ua);

        if ($bot) {
            try {
                Http::withToken(config('services.bluemonitor.key'))
                    ->timeout(5)
                    ->post('https://www.bluemonitor.org/api/v1/bot-visits', [
                        'domain' => 'yourapp.com',
                        'visits' => [[
                            'bot_name' => $bot['name'],
                            'bot_category' => $bot['category'],
                            'path' => $request->path(),
                            'user_agent' => $ua,
                        ]],
                    ]);
            } catch (\Exception $e) {
                // ignore
            }
        }

        return $next($request);
    }

    private function identifyBot(string $ua): ?array
    {
        foreach (self::BOT_PATTERNS as [$pattern, $name, $category]) {
            if (preg_match($pattern, $ua)) {
                return ['name' => $name, 'category' => $category];
            }
        }
        return null;
    }
}
```

Register in `bootstrap/app.php` (Laravel 11+):

```php
->withMiddleware(function (Middleware $middleware) {
    $middleware->web(append: [
        \App\Http\Middleware\TrackBots::class,
    ]);
})
```

- Requires Pro plan + `BLUEMONITOR_API_KEY` in `config/services.php`
- View results in the BlueMonitor dashboard under "Bot Tracking"
