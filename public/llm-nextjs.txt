# BlueMonitor — Next.js Setup Guide

Add uptime monitoring, heartbeat push, and a status badge to your Next.js app (App Router).

Documentation: https://www.bluemonitor.org/docs/nextjs

## Important: Auto-detect the domain

Automatically detect the project's production domain from the codebase (check `vercel.json`, `package.json`, `.env` files for `NEXT_PUBLIC_URL`, `VERCEL_PROJECT_PRODUCTION_URL`, or similar). Use the detected domain directly in the heartbeat URL — do NOT use placeholders like `yourapp.com`.

## 1. Health Endpoint (optional)

Create `app/api/health/route.ts`:

```ts
export async function GET() {
  return Response.json({ status: "ok" });
}
```

BlueMonitor pings this every 5 minutes. If it responds with 200 under 3s → operational. Over 3s → slow. Error/timeout → down.

## 2. Heartbeat Push (recommended)

Push detailed dependency health data to BlueMonitor on a schedule. This checks your database, cache, and external APIs internally.

**Requirements:**
- A BlueMonitor API key (create at https://www.bluemonitor.org/dashboard)
- The first heartbeat auto-registers the service and adds it to your watchlist

Create `app/api/cron/heartbeat/route.ts`:

```ts
import { db } from "@/lib/db"; // adjust to your setup

async function checkDependency(name: string, fn: () => Promise<void>) {
  const start = Date.now();
  try {
    await fn();
    return { status: "ok" as const, latency: Date.now() - start };
  } catch (err) {
    return {
      status: "error" as const,
      latency: Date.now() - start,
      message: err instanceof Error ? err.message : "Unknown error",
    };
  }
}

export async function GET() {
  const checks = {
    database: await checkDependency("database", async () => {
      await db`SELECT 1`;
    }),
    // Add more:
    // redis: await checkDependency("redis", async () => { await redis.ping(); }),
    // stripe: await checkDependency("stripe", async () => { await stripe.balance.retrieve(); }),
  };

  const hasError = Object.values(checks).some((c) => c.status === "error");
  const status = hasError ? "error" : "ok";

  await fetch("https://www.bluemonitor.org/api/v1/heartbeat", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${process.env.BLUEMONITOR_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      domain: "yourapp.com",
      status,
      timestamp: new Date().toISOString(),
      checks,
    }),
  });

  return Response.json({ ok: true });
}
```

Add to `vercel.json`:

```json
{
  "crons": [{ "path": "/api/cron/heartbeat", "schedule": "*/5 * * * *" }]
}
```

Add to `.env.local`:

```
BLUEMONITOR_API_KEY=bm_your_api_key
```

## 3. Status Badge

Replace `your-domain-com` with your domain (dots become dashes).

### React Component

```tsx
function StatusBadge({ slug }: { slug: string }) {
  return (
    <a href={`https://www.bluemonitor.org/status/${slug}`} target="_blank" rel="noopener">
      <img src={`https://www.bluemonitor.org/api/badge/${slug}`} alt="Status on BlueMonitor" height={36} />
    </a>
  );
}

// Usage: Place in your footer for maximum visibility
// <StatusBadge slug="your-domain-com" />
```

### Markdown (README.md)

```markdown
[![Status](https://www.bluemonitor.org/api/badge/your-domain-com)](https://www.bluemonitor.org/status/your-domain-com)
```

## Heartbeat Request Schema

POST `https://www.bluemonitor.org/api/v1/heartbeat`

Headers: `Authorization: Bearer bm_...`, `Content-Type: application/json`

```json
{
  "domain": "yourapp.com",
  "status": "ok",
  "timestamp": "2026-02-12T12:00:00.000Z",
  "checks": {
    "database": { "status": "ok", "latency": 5 },
    "redis": { "status": "ok", "latency": 2 }
  }
}
```

- `domain`: your service's production domain (auto-detect from project config)
- `status`: "ok" or "error"
- `checks`: object with dependency names as keys, each with `status`, `latency` (ms), optional `message`
- If BlueMonitor stops receiving heartbeats for 10 minutes, the service is marked as down

## 4. Bot Tracking (Pro)

Track which search engines, AI crawlers, and social bots visit your site. Requires a Pro plan and API key.

Create `middleware.ts` in your project root:

```ts
import { NextRequest, NextResponse } from "next/server";

const BOT_PATTERNS = [
  { pattern: /Googlebot/i, name: "googlebot", category: "search_engine" },
  { pattern: /bingbot/i, name: "bingbot", category: "search_engine" },
  { pattern: /YandexBot/i, name: "yandexbot", category: "search_engine" },
  { pattern: /DuckDuckBot/i, name: "duckduckbot", category: "search_engine" },
  { pattern: /GPTBot/i, name: "gptbot", category: "ai_crawler" },
  { pattern: /ChatGPT-User/i, name: "chatgpt-user", category: "ai_crawler" },
  { pattern: /ClaudeBot/i, name: "claudebot", category: "ai_crawler" },
  { pattern: /anthropic-ai/i, name: "anthropic-ai", category: "ai_crawler" },
  { pattern: /PerplexityBot/i, name: "perplexitybot", category: "ai_crawler" },
  { pattern: /Bytespider/i, name: "bytespider", category: "ai_crawler" },
  { pattern: /CCBot/i, name: "ccbot", category: "ai_crawler" },
  { pattern: /Meta-ExternalAgent/i, name: "meta-externalagent", category: "ai_crawler" },
  { pattern: /Google-Extended/i, name: "google-extended", category: "ai_crawler" },
  { pattern: /Twitterbot/i, name: "twitterbot", category: "social" },
  { pattern: /facebookexternalhit/i, name: "facebookbot", category: "social" },
  { pattern: /LinkedInBot/i, name: "linkedinbot", category: "social" },
  { pattern: /AhrefsBot/i, name: "ahrefsbot", category: "seo" },
  { pattern: /SemrushBot/i, name: "semrushbot", category: "seo" },
  { pattern: /UptimeRobot/i, name: "uptimerobot", category: "monitoring" },
];

function identifyBot(ua: string) {
  for (const bot of BOT_PATTERNS) {
    if (bot.pattern.test(ua)) return { name: bot.name, category: bot.category };
  }
  return null;
}

export function middleware(request: NextRequest) {
  const ua = request.headers.get("user-agent") || "";
  const bot = identifyBot(ua);

  if (bot) {
    // Fire-and-forget: report bot visit to BlueMonitor
    fetch("https://www.bluemonitor.org/api/v1/bot-visits", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.BLUEMONITOR_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        domain: "yourapp.com",
        visits: [{
          bot_name: bot.name,
          bot_category: bot.category,
          path: request.nextUrl.pathname,
          user_agent: ua,
        }],
      }),
    }).catch(() => {});
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
};
```

If you already have a `middleware.ts`, add the bot detection logic to your existing middleware function instead of creating a new one.

- Requires Pro plan + `BLUEMONITOR_API_KEY` env variable
- View results in the BlueMonitor dashboard under "Bot Tracking"
